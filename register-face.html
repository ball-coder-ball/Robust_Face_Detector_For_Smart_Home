<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Data Collection - บันทึกข้อมูลใบหน้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #1a1a1a; color: #ffffff; overflow-x: hidden; }
        .hero-title { font-family: 'Crimson Text', serif; font-weight: 700; }
        .gradient-text { background: linear-gradient(135deg, #00ff88, #00ccff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .camera-container { position: relative; border: 3px solid #00ff88; border-radius: 16px; overflow: hidden; background: #000; }
        .capture-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 255, 136, 0.1); opacity: 0; transition: opacity 0.3s ease; }
        .capture-overlay.active { opacity: 1; animation: flash 0.3s ease; }
        @keyframes flash { 0%, 100% { opacity: 0.1; } 50% { opacity: 0.3; } }
        .progress-bar { background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; height: 20px; }
        .progress-fill { background: linear-gradient(90deg, #00ff88, #00ccff); height: 100%; border-radius: 10px; transition: width 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, #00ff88, #00cc6a); border: none; color: #0a0a0a; font-weight: 600; padding: 16px 32px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; width: 100%; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; background: #00ff88; color: black; }
    </style>
</head>
<body>
    <main class="container mx-auto px-6 py-8">
        <div class="text-center mb-8">
            <h1 class="hero-title text-4xl md:text-5xl mb-4"><span class="gradient-text">บันทึกข้อมูลใบหน้า</span></h1>
            <p class="text-xl text-gray-300">ระบบจะถ่ายภาพอัตโนมัติ 5 ภาพ</p>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="camera-container aspect-video relative mb-4">
                    <video id="cameraFeed" class="w-full h-full object-cover"></video>
                    <div class="capture-overlay" id="captureOverlay"></div>
                    <div class="absolute top-4 left-4 bg-black bg-opacity-50 rounded-lg p-3 text-green-400 font-medium">กำลังบันทึก...</div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">ความคืบหน้า</span>
                        <span class="text-sm text-green-400" id="progressText">0/5 ภาพ</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-gray-800 bg-opacity-50 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 text-green-400">สถานะ</h3>
                    <p>ชื่อผู้ใช้: <span id="dispName" class="text-white font-bold">...</span></p>
                    <p>ID: <span id="dispId" class="text-gray-400 font-mono text-sm">...</span></p>
                </div>
                <button id="startCaptureBtn" class="btn-primary">เริ่มบันทึกข้อมูล</button>
            </div>
        </div>
    </main>

    <script src="main.js"></script>
    <script>
        const TOTAL_IMAGES = 5;
        let capturedImages = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const uid = urlParams.get('user_id');

            document.getElementById('dispName').textContent = name;
            document.getElementById('dispId').textContent = uid;

            const video = document.getElementById('cameraFeed');
            const startBtn = document.getElementById('startCaptureBtn');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            // Start Camera
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.play();

            startBtn.addEventListener('click', async () => {
                startBtn.disabled = true;
                startBtn.textContent = "กำลังถ่ายภาพ...";
                
                for(let i=0; i<TOTAL_IMAGES; i++) {
                    // Capture
                    const cvs = document.createElement('canvas');
                    cvs.width = video.videoWidth; cvs.height = video.videoHeight;
                    cvs.getContext('2d').drawImage(video, 0, 0);
                    capturedImages.push(cvs.toDataURL('image/jpeg'));

                    // UI Effect
                    document.getElementById('captureOverlay').classList.add('active');
                    setTimeout(() => document.getElementById('captureOverlay').classList.remove('active'), 100);

                    // Update Progress
                    const pct = ((i+1)/TOTAL_IMAGES)*100;
                    progressFill.style.width = `${pct}%`;
                    progressText.textContent = `${i+1}/${TOTAL_IMAGES} ภาพ`;

                    await new Promise(r => setTimeout(r, 800)); // Delay
                }

                startBtn.textContent = "กำลังบันทึก...";
                
                // Send to Backend
                const res = await fetch(`${faceSystem.apiBaseUrl}/api/v1/register-faces`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: uid,
                        name: name,
                        images: capturedImages
                    })
                });
                const data = await res.json();

                if(data.success) {
                    faceSystem.showNotification('บันทึกเสร็จสิ้น! ไปหน้าสแกน', 'success');
                    setTimeout(() => window.location.href = 'scan.html', 2000);
                } else {
                    alert("Error saving faces");
                    window.location.reload();
                }
            });
        });
    </script>
</body>
</html>